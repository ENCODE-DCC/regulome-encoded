language: python
sudo: required
dist: trusty
cache:
  directories:
    - eggs
    - .npm
notifications:
  slack:
    secure: hlTj34WpuzQmsyxnUnFEwlAJeDcElshGfgw7oHuicAD83LorBFTc9ap6FhZXI5LFnqEl28FZ9YkJJRl0tFZgaApllrMmNCeK2FfRjnF8XGz2JS6Iiyj+hgWrKHHIbcS2g5R6L2/uzIhdMvCb97cReZckjo9lumYAdXGHY8DJbik=
addons:
  apt:
    packages:
      - oracle-java8-set-default
      - bsdtar
      - graphviz
env:
  global:
    # SAUCE_USERNAME
    - secure: oVDMU2P2QReRS01q0SVC02oBVXQC5ya6fP3CfAgBMVs/ruW4Qv1BONSd0KpyXH6R+NmGN06OhrRTZzS3hEYdtpra/p8k7Oz0DqnGUyiLUpaSM49zS4PahkpyRB+kwMWmzitWilOlMTp37JlglIqfDMQmgeeho83Gh2T+Lv9byb4Q2X6xNgA7bwmOs97KR6L7FNcPLjG7Rd6rpRfDNnF72ZsGr6DEuvzrzXXzXiW+MmqKiOURSXcT0jlQMkNFUdjgDxql0ooshWAFj9qk8i0hlPkthdOrlwVMT85Z4Bh+RqsByn1wy9aTSIaNFRVvIYMshyfdjfR7jt13sbGT6Jr5gKY/bD6gsEs2k3N4ZRw134yNdoNkS9M6trevRFucoSKf447yj2Cy+DQG73p9QbCjUCunDiTjOTSN3/vLBZZSQ3O+rfJrdfRCPxSY4LRyMQcO5W0OMEgSU2+VO+ayAQQDaE0dgK/LQIL5dPnksO0vMcgGcZo0ueTqiUFVj9yQuUC6xMm40Xff8uuDy/aWbC3FOFhZGnAztRMP1CXeGgA+4Dvyb6gwNHQpyriiVVBStJkdb2gBQ+nvPLmtwgtWtsLW675rz5TW1FhGJMnwAI5SDOja3wjwRaO2Je9yzDPL7cvT/u7rtgvexBltaWpvWiZ7ddRcTLT1b3SLShTq3Wg2BvI=
  # SAUCE_ACCESS_KEY
    - secure: WZI1DFISnfg9OLnHBdWycX+Rwi9Fg/O20L6xIqm+oHPGZVKbn/F+nwezywClgXf4zwsOuYndpggAk1NMUIe+SEbysDVuCbAcaJo2lttHEIlbQrRIuc7M80G9kIWLVQJYrarYVIYbVONGuEa6pHbduwgN5xS4oG9UvM9YvN+g3oTs/5x4LQ4LNHJkypN57+uvE1oFu258DScj4DIf5uAaN4oQXKwaQ6S5g5geL9JXsKn1j/EIwdc2aRg712tysvMAn7X2r7LAFiBJybldKZxhp1OjWMpMnX4JDpxR+S4xe3rYT7jY2zDm87K+ikB0mmwANgvKsrsRlQX74taBCKmUdwaIJcQWeWWN7e+wRI4DeEw7D40uc0OJ6PSC5EAEGKRlc1UBfZ59sxM0Ygy8rKp3s5uy4NtGda2GneDK6kS0sFfc7VHPxpKTo05+AYkE3fabj4a3OFsYsjci0h6sHwRD+ecD26vGGsN9VPHWxDw37eyQnznJDEYMesn3oCDchAfVpV4h3NuqLf7inmzT8WoMIXnTVCerX9/4PirvswZPs2c25KDtnnQuWska5vliIAy63m9IbTzV3bqVSnBaI+OGAdx/IKkVyG+YSV0zTAAMHAKRfaMk/DfIaMwkIPivswdEnbe8K4RNCVIpnJONf+a0ZcUcfVcSCczMvRtPj4iYOig=
    - BOTO_CONFIG=tmp/bogusvalue
    - JAVA_HOME=/usr/lib/jvm/java-8-oracle
    - ES_VERSION=5.6.1
    - ES_DOWNLOAD_URL=https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-${ES_VERSION}.deb
    - PATH="/usr/share/elasticsearch/bin:/usr/lib/postgresql/9.3/bin:$PATH"
    - ES_JAVA_OPTS="-Xms2g -Xmx2g"
matrix:
  include:
    - python: "3.4.3"
      env: BROWSER=Chrome
    - python: "3.4.3"
      env: BROWSER=
before_install:
  - postgres --version
  - initdb --version
  - nvm install 6
  - node --version
  - npm config set python /usr/bin/python2.7
  - curl -O  ${ES_DOWNLOAD_URL} && sudo dpkg -i --force-confnew elasticsearch-${ES_VERSION}.deb && sudo service elasticsearch stop
  - pip install -U zc.buildout setuptools
install:
  - buildout bootstrap
  - bin/buildout -c buildout-travis.cfg || (echo "Retrying buildout" && bin/buildout -c buildout-travis.cfg)
  - sudo chown -R travis /etc/elasticsearch
before_script:
  - >
    if test -n "$BROWSER"; then
      CONNECT_URL=https://saucelabs.com/downloads/sc-4.4.5-linux.tar.gz
      CONNECT_DOWNLOAD=sc.tar.gz
      SC_READYFILE=sauce-connect-ready-$RANDOM
      SC_LOGFILE=$HOME/sauce-connect.log
      SC_PIDFILE=$HOME/sauce-connect.pid
      curl $CONNECT_URL > $CONNECT_DOWNLOAD
      mkdir sc
      tar -zxf $CONNECT_DOWNLOAD --strip 1 --directory sc
      sc/bin/sc --readyfile $SC_READYFILE \
        --logfile $SC_LOGFILE \
        --pidfile $SC_PIDFILE \
        --tunnel-identifier $TRAVIS_JOB_NUMBER \
        --user $SAUCE_USERNAME --api-key $SAUCE_ACCESS_KEY > /dev/null &
      while test -f "$SC_PIDFILE" && test ! -f "$SC_READYFILE"; do sleep .5; done
    fi
script:
  - if test -z "$BROWSER"; then npm test; fi
  - if test -z "$BROWSER"; then bin/test -v -v --timeout=400 -m "not bdd"; fi
  - >
    if test -n "$BROWSER"; then
      test -f "$SC_PIDFILE" && bin/test -v -v --timeout=400 -m "bdd" --tb=short \
        --splinter-implicit-wait 10 \
        --splinter-webdriver remote \
        --splinter-remote-url "http://$SAUCE_USERNAME:$SAUCE_ACCESS_KEY@localhost:4445/wd/hub" \
        --splinter-socket-timeout 300 \
        --browser-arg tunnel-identifier "$TRAVIS_JOB_NUMBER" \
        --browser-arg-int build  "$TRAVIS_BUILD_NUMBER" \
        --browser-arg-int idleTimeout 300 \
        --browser-arg name "$TRAVIS_REPO_SLUG $TRAVIS_BRANCH $TRAVIS_COMMIT" \
        --browser-arg browser "$BROWSER" \
        --browser-arg platform "Linux"
    fi
after_script:
  - >
    if test -f "$SC_PIDFILE"; then
      SAUCE_JOB_ID=`grep -m 1 /session/ "$HOME/sauce-connect.log" | cut -d / -f 7`
      SAUCE_PASSED=`((TRAVIS_TEST_RESULT == 0)) && echo true || echo false`
      curl -H "Content-Type:text/json" -s -X PUT -d "{\"passed\": $SAUCE_PASSED}" \
        "http://$SAUCE_USERNAME:$SAUCE_ACCESS_KEY@saucelabs.com/rest/v1/$SAUCE_USERNAME/jobs/$SAUCE_JOB_ID" > /dev/null
      echo "Sauce test page https://saucelabs.com/tests/$SAUCE_JOB_ID"
      kill $(cat "$SC_PIDFILE")
      wait $(cat "$SC_PIDFILE")
    fi
